from django.db import migrations

SQL = """
CREATE TABLE IF NOT EXISTS poker_exploittag (
    id bigserial PRIMARY KEY,
    name varchar(80) NOT NULL UNIQUE,
    description varchar(200) NOT NULL DEFAULT ''
);

CREATE TABLE IF NOT EXISTS poker_playerexploit (
    id bigserial PRIMARY KEY,
    player_id bigint NOT NULL REFERENCES poker_playerprofile(id) ON DELETE CASCADE,
    tag_id bigint NOT NULL REFERENCES poker_exploittag(id) ON DELETE CASCADE,
    strength smallint NOT NULL DEFAULT 1,
    confidence smallint NOT NULL DEFAULT 3,
    note varchar(240) NOT NULL DEFAULT '',
    updated timestamptz NOT NULL DEFAULT now(),
    CONSTRAINT uniq_player_exploit_tag UNIQUE (player_id, tag_id)
);

CREATE INDEX IF NOT EXISTS poker_playerexploit_player_id_idx ON poker_playerexploit(player_id);
CREATE INDEX IF NOT EXISTS poker_playerexploit_tag_id_idx ON poker_playerexploit(tag_id);
"""

REVERSE_SQL = """
-- Reverse only if you truly want to drop these tables:
-- DROP TABLE IF EXISTS poker_playerexploit;
-- DROP TABLE IF EXISTS poker_exploittag;
"""

class Migration(migrations.Migration):
    dependencies = [
        ("poker", "0002_exploittag_playertag_alter_pokersession_stakes_and_more"),
    ]

    operations = [
        migrations.RunSQL(SQL, reverse_sql=REVERSE_SQL),
    ]
